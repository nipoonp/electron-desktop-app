name: Tabin CI/CD NEW

on:
    push:
        branches: [hare-krishna]

jobs:
    slack_message_start:
        runs-on: ubuntu-latest
        steps:
            - name: Post to a Slack channel
              id: slack
              uses: slackapi/slack-github-action@v1.23.0
              with:
                  channel-id: ${{ secrets.SLACK_BOT_CHANNEL_ID }}
                  slack-message: "Electron build started!"
              env:
                  SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    create_release:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3.3.0
            - name: get-npm-version
              id: package-version
              uses: martinbeentjes/npm-get-version-action@master
            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
              with:
                  tag_name: v${{steps.package-version.outputs.current-version}}
                  release_name: v${{steps.package-version.outputs.current-version}}
                  body: ðŸš€ðŸš€ðŸ”¥ Release auto-generated by Github actions CI/CD. ðŸ”¥ðŸš€ðŸš€
                  draft: true
                  prerelease: false
    windows:
        runs-on: windows-latest
        env:
            CI: false #Need this otherwise github actions will do this => "Treating warnings as errors because process.env.CI = true"
        steps:
            - uses: actions/checkout@v3.3.0
            - uses: actions/setup-node@v3.6.0
              with:
                  node-version: 16
            - name: Install windows build tools
              run: npm install --global --production windows-build-tools@4.0.0
            - name: Set npm config set msvs_version 2019 --global
              run: npm config set msvs_version 2019 --global
            - name: Install node-gyp
              run: npm install --global node-gyp@latest
            - name: Install electron-builder
              run: npm install --global electron-builder
            - name: Install dependencies
              run: npm install --legacy-peer-deps
            - name: Build native dependencies
              run: ./node_modules/.bin/electron-rebuild
            - name: Build web
              run: npm run build:web
            - name: Build desktop
              run: npm run build:desktop
            - name: Release Electron app
              run: electron-builder -w -p 'onTagOrDraft'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
    # macos:
    #     runs-on: macos-latest
    #     env:
    #         CI: false #Need this otherwise github actions will do this => "Treating warnings as errors because process.env.CI = true"
    #     steps:
    #         - uses: actions/checkout@v3.3.0
    #         - uses: actions/setup-node@v3.6.0
    #           with:
    #               node-version: 16
    #         - name: Install dependencies
    #           run: npm install --legacy-peer-deps
    #         - name: Build native dependencies
    #           run: ./node_modules/.bin/electron-rebuild
    #         - name: Build web
    #           run: npm run build:web
    #         - name: Build desktop
    #           run: npm run build:desktop
    #         - name: Release Electron app
    #           run: electron-builder -m -p 'onTagOrDraft'
    #           env:
    #               GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
    slack_message_complete:
        needs: [slack_message_start, create_release, windows]
        runs-on: ubuntu-latest
        steps:
            - name: Post to a Slack channel
              id: slack
              uses: slackapi/slack-github-action@v1.23.0
              with:
                  channel-id: ${{ secrets.SLACK_BOT_CHANNEL_ID }}
                  slack-message: "Electron build completed! ðŸš€ðŸš€ðŸ”¥"
              env:
                  SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
